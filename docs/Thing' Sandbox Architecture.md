# Thing' Sandbox: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

## 1. –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

–ö–æ–Ω—Ü–µ–ø—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –æ–ø–∏—Å–∞–Ω–∞ –≤ [Thing' Sandbox Concept.md](Thing'%20Sandbox%20Concept.md).

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é: —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞, –º–æ–¥—É–ª–∏, —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é.

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö —Å–∏–º—É–ª—è—Ü–∏–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.

---

## 2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
thing'-sandbox/
‚îú‚îÄ‚îÄ docs/                     # –ø—Ä–æ–µ–∫—Ç–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ specs/                # —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –º–æ–¥—É–ª–µ–π
‚îÇ   ‚îî‚îÄ‚îÄ tasks/                # –∑–∞–¥–∞–Ω–∏—è –¥–ª—è Claude Code
‚îÇ
‚îú‚îÄ‚îÄ config.toml               # –≥–ª–æ–±–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ schemas/              # JSON-—Å—Ö–µ–º—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ prompts/              # –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ phases/               # —Ñ–∞–∑—ã —Ç–∞–∫—Ç–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ common.py         # –æ–±—â–∏–µ —Ç–∏–ø—ã (PhaseResult)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ phase1.py         # –Ω–∞–º–µ—Ä–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ phase2a.py        # —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Å—Ü–µ–Ω—ã (–∞—Ä–±–∏—Ç—Ä)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ phase2b.py        # –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞—Ä—Ä–∞—Ç–∏–≤–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ phase3.py         # –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ phase4.py         # –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
‚îÇ   ‚îú‚îÄ‚îÄ utils/                # –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ exit_codes.py     # –∫–æ–¥—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ llm.py            # LLM Client (—Ñ–∞—Å–∞–¥ –¥–ª—è —Ñ–∞–∑)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ llm_errors.py     # –∏–µ—Ä–∞—Ä—Ö–∏—è –æ—à–∏–±–æ–∫ LLM
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ llm_adapters/     # —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–π —Å–ª–æ–π
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.py       # –æ–±—â–∏–µ —Ç–∏–ø—ã (AdapterResponse, ResponseUsage)
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ openai.py     # OpenAI Responses API adapter
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prompts.py        # —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø—Ä–æ–º–ø—Ç–æ–≤ (Jinja2)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ storage.py        # —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å —Å–∏–º—É–ª—è—Ü–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ cli.py                # —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (typer)
‚îÇ   ‚îú‚îÄ‚îÄ config.py             # –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ runner.py             # –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è —Ç–∞–∫—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ narrators.py          # –≤—ã–≤–æ–¥: console, telegram, web
‚îÇ   ‚îî‚îÄ‚îÄ tick_logger.py        # –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∏–∫–æ–≤ (markdown)
‚îÇ
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ unit/                 # —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ integration/          # –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ conftest.py           # —Ñ–∏–∫—Å—Ç—É—Ä—ã pytest
‚îÇ
‚îú‚îÄ‚îÄ simulations/              # –¥–∞–Ω–Ω—ã–µ —Å–∏–º—É–ª—è—Ü–∏–π (–≤ .gitignore)
‚îÇ
‚îú‚îÄ‚îÄ requirements.txt          # runtime-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ requirements-dev.txt      # dev-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (pytest, mypy, ruff)
‚îú‚îÄ‚îÄ pyproject.toml            # –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–∫–µ—Ç–∞ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
‚îú‚îÄ‚îÄ .env.example              # —à–∞–±–ª–æ–Ω –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ CLAUDE.md                 # –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è Claude Code
‚îî‚îÄ‚îÄ README.md
```

---

## 3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∏–º—É–ª—è—Ü–∏–∏

### –ü–∞–ø–∫–∞ —Å–∏–º—É–ª—è—Ü–∏–∏

```
simulations/
  sim-01/
    simulation.json       # –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∏–º—É–ª—è—Ü–∏–∏
    characters/
      bob.json
      elvira.json
    locations/
      tavern.json
      forest.json
    logs/
      tick_000001.md
      tick_000002.md
    prompts/              # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
      phase2b_narrative_system.md
```

### simulation.json

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∏–º—É–ª—è—Ü–∏–∏:

```json
{
  "id": "sim-01",
  "current_tick": 42,
  "created_at": "2025-01-15T10:00:00Z",
  "status": "paused"
}
```

### –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ –∏ –ª–æ–∫–∞—Ü–∏–∏

- –ö–∞–∂–¥—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂ ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π JSON —Ñ–∞–π–ª –≤ `characters/`
- –ö–∞–∂–¥–∞—è –ª–æ–∫–∞—Ü–∏—è ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π JSON —Ñ–∞–π–ª –≤ `locations/`
- –°–≤—è–∑–∏ –º–µ–∂–¥—É –ª–æ–∫–∞—Ü–∏—è–º–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –ª–æ–∫–∞—Ü–∏–π (`connections`)
- –¢–µ–∫—É—â–∞—è –ª–æ–∫–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (`state.location`)

### –õ–æ–≥–∏

- –ù–∞—Ä—Ä–∞—Ç–∏–≤—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `logs/` –ø–æ —Ç–∞–∫—Ç–∞–º
- –§–æ—Ä–º–∞—Ç: `tick_NNNNNN.md` (6 —Ü–∏—Ñ—Ä, —Å –≤–µ–¥—É—â–∏–º–∏ –Ω—É–ª—è–º–∏)

### –°–ª—É–∂–µ–±–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ LLM (`_openai`)

Entities (–ø–µ—Ä—Å–æ–Ω–∞–∂–∏, –ª–æ–∫–∞—Ü–∏–∏) –∏ `simulation.json` —Å–æ–¥–µ—Ä–∂–∞—Ç namespace `_openai` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è:
- **Response chains** ‚Äî —Ü–µ–ø–æ—á–∫–∏ `response_id` –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–µ–∂–¥—É —Ç–∞–∫—Ç–∞–º–∏
- **Usage statistics** ‚Äî –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤

–ü—Ä–∏–º–µ—Ä –≤ `characters/bob.json`:
```json
{
  "identity": {...},
  "state": {...},
  "memory": {...},
  "_openai": {
    "intention_chain": ["resp_abc123", "resp_def456"],
    "memory_chain": ["resp_xyz789"],
    "usage": {
      "total_input_tokens": 125000,
      "total_output_tokens": 8500,
      "total_requests": 42
    }
  }
}
```

**–í–∞–∂–Ω–æ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ–∞–∑:** –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `LLMClient` —Å `entity_key` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `"intention:bob"`), –∫–ª–∏–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. –ò–∑–≤–ª–µ–∫–∞–µ—Ç `previous_response_id` –∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π chain
2. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π `response_id` –≤ chain
3. –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç usage —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: [LLM Approach v2 ‚Üí –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è](Thing'%20Sandbox%20LLM%20Approach%20v2.md#8-—Ö—Ä–∞–Ω–µ–Ω–∏–µ-—Å–æ—Å—Ç–æ—è–Ω–∏—è)

---

## 4. –ü—Ä–æ–º–ø—Ç—ã

### –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ

- –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ: `src/prompts/`
- –ö–∞—Å—Ç–æ–º–Ω—ã–µ: `simulations/{sim-id}/prompts/`

### –§–∞–π–ª—ã –ø—Ä–æ–º–ø—Ç–æ–≤

–ö–∞–∂–¥–∞—è —Ñ–∞–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–≤–∞ –ø—Ä–æ–º–ø—Ç–∞ ‚Äî system –∏ user:

```
phase1_intention_system.md      # —Ñ–∞–∑–∞ 1 ‚Äî system prompt
phase1_intention_user.md        # —Ñ–∞–∑–∞ 1 ‚Äî user prompt
phase2a_resolution_system.md    # —Ñ–∞–∑–∞ 2a ‚Äî system prompt
phase2a_resolution_user.md      # —Ñ–∞–∑–∞ 2a ‚Äî user prompt
phase2b_narrative_system.md     # —Ñ–∞–∑–∞ 2b ‚Äî system prompt
phase2b_narrative_user.md       # —Ñ–∞–∑–∞ 2b ‚Äî user prompt
phase4_summary_system.md        # —Ñ–∞–∑–∞ 4 ‚Äî system prompt
phase4_summary_user.md          # —Ñ–∞–∑–∞ 4 ‚Äî user prompt
```

### –†–µ–∑–æ–ª–≤ –ø—Ä–æ–º–ø—Ç–∞

1. –ò—â–µ–º `simulations/{sim-id}/prompts/{prompt}.md`
2. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –±–µ—Ä—ë–º `src/prompts/{prompt}.md`

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å —Å—Ç–∏–ª—å –Ω–∞—Ä—Ä–∞—Ç–∏–≤–∞ (—Ñ—ç–Ω—Ç–µ–∑–∏, –∫–∏–±–µ—Ä–ø–∞–Ω–∫) –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏, –Ω–µ –¥—É–±–ª–∏—Ä—É—è –≤—Å–µ –ø—Ä–æ–º–ø—Ç—ã.

---

## 5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏–º—É–ª—è—Ü–∏–∏

### –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏

–ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø–∞–ø–∫–∞ —Å–∏–º—É–ª—è—Ü–∏–∏ —Å–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º:

```
simulation-name/
  simulation.json         # current_tick: 0, status: "paused"
  characters/             # –Ω–∞—á–∞–ª—å–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏
  locations/              # –Ω–∞—á–∞–ª—å–Ω—ã–µ –ª–æ–∫–∞—Ü–∏–∏
  logs/                   # –ø—É—Å—Ç–∞—è –ø–∞–ø–∫–∞
  prompts/                # –ø—Ä–æ–º–ø—Ç—ã —Å–∏–º—É–ª—è—Ü–∏–∏
```

### –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–º—è—Ç–∏

–ü–∞–º—è—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—É—Å—Ç–∞—è:

```json
"memory": {
  "cells": [],
  "summary": ""
}
```

–ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –ø—Ä–æ—â–µ —á–µ–º null, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫.

### –°—Ç–∞—Ç—É—Å—ã —Å–∏–º—É–ª—è—Ü–∏–∏

| –°—Ç–∞—Ç—É—Å | –ó–Ω–∞—á–µ–Ω–∏–µ |
|--------|----------|
| `running` | –¢–∞–∫—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å |
| `paused` | –ú–µ–∂–¥—É —Ç–∞–∫—Ç–∞–º–∏, –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—é |

–ö–æ–º–±–∏–Ω–∞—Ü–∏—è `current_tick: 0` + `status: "paused"` –æ–∑–Ω–∞—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω–Ω—É—é —Å–∏–º—É–ª—è—Ü–∏—é, –≤ –∫–æ—Ç–æ—Ä–æ–π –µ—â—ë –Ω–µ –±—ã–ª–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ç–∞–∫—Ç–∞.

---

## 5.1 –®–∞–±–ª–æ–Ω—ã –∏ —Å–±—Ä–æ—Å —Å–∏–º—É–ª—è—Ü–∏–∏

### –ü–∞–ø–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤

–®–∞–±–ª–æ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `simulations/_templates/`. –ü—Ä–µ—Ñ–∏–∫—Å `_` –∏—Å–∫–ª—é—á–∞–µ—Ç
–ø–∞–ø–∫—É –∏–∑ —Å–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–∏–º—É–ª—è—Ü–∏–π.

```
simulations/
  _templates/           # —à–∞–±–ª–æ–Ω—ã
    demo-sim/           # —à–∞–±–ª–æ–Ω –¥–µ–º–æ-—Å–∏–º—É–ª—è—Ü–∏–∏
      simulation.json
      characters/
      locations/
      logs/             # –ø—É—Å—Ç–∞—è –ø–∞–ø–∫–∞ (.gitkeep)
  demo-sim/             # —Ä–∞–±–æ—á–∞—è –∫–æ–ø–∏—è (–º—É—Ç–∏—Ä—É–µ—Ç)
```

### –°–±—Ä–æ—Å –∫ —à–∞–±–ª–æ–Ω—É

–ö–æ–º–∞–Ω–¥–∞ `reset` –∫–æ–ø–∏—Ä—É–µ—Ç —à–∞–±–ª–æ–Ω –ø–æ–≤–µ—Ä—Ö —Ä–∞–±–æ—á–µ–π —Å–∏–º—É–ª—è—Ü–∏–∏:

```bash
python -m src.cli reset demo-sim
```

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**
- –®–∞–±–ª–æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –ø–æ–≤–µ—Ä—Ö —Ä–∞–±–æ—á–µ–π —Å–∏–º—É–ª—è—Ü–∏–∏
- –†–∞–±–æ—á–µ–π —Å–∏–º—É–ª—è—Ü–∏–∏ –Ω–µ—Ç ‚Üí —Å–æ–∑–¥–∞—ë—Ç—Å—è –∏–∑ —à–∞–±–ª–æ–Ω–∞
- –ü–∞–ø–∫–∞ `logs/` –æ—á–∏—â–∞–µ—Ç—Å—è
- –®–∞–±–ª–æ–Ω–∞ –Ω–µ—Ç ‚Üí –æ—à–∏–±–∫–∞

### –î–µ–º–æ-—Å–∏–º—É–ª—è—Ü–∏—è

`demo-sim` ‚Äî —Ç–µ—Å—Ç–æ–≤–∞—è —Å–∏–º—É–ª—è—Ü–∏—è –ø–æ –º–æ—Ç–∏–≤–∞–º "–í–æ–π–Ω—ã –º–∏—Ä–æ–≤" –£—ç–ª–ª—Å–∞.
–®–∞–±–ª–æ–Ω: `simulations/_templates/demo-sim/`.

---

## 6. –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å —Ç–∞–∫—Ç–∞

### –ü—Ä–∏–Ω—Ü–∏–ø

–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏–º—É–ª—è—Ü–∏–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–∞–∫—Ç–∞ ‚Äî –≤—Å–µ 4 —Ñ–∞–∑—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, –≤—Å–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–æ–π–¥–µ–Ω—ã.

### –°–ª–µ–¥—Å—Ç–≤–∏—è

- –ù–∏–∫–∞–∫–∏—Ö temp-—Ñ–∞–π–ª–æ–≤ –∏ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
- –ü—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ –Ω–∞ –ª—é–±–æ–π —Ñ–∞–∑–µ ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å `current_tick`
- `current_tick` –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ

### –ü–æ—Ä—è–¥–æ–∫ –∑–∞–ø–∏—Å–∏ –≤ –∫–æ–Ω—Ü–µ —Ç–∞–∫—Ç–∞

1. –û–±–Ω–æ–≤–∏—Ç—å `characters/*.json` (—Å–æ—Å—Ç–æ—è–Ω–∏—è + –ø–∞–º—è—Ç—å)
2. –û–±–Ω–æ–≤–∏—Ç—å `locations/*.json` (—Å–æ—Å—Ç–æ—è–Ω–∏—è)
3. –ó–∞–ø–∏—Å–∞—Ç—å `logs/tick_NNNNNN.md`
4. –û–±–Ω–æ–≤–∏—Ç—å `simulation.json` (–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç `current_tick`, —Å—Ç–∞—Ç—É—Å `paused`)

–ï—Å–ª–∏ –ø–∞–¥–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ –º–µ–∂–¥—É –ø—É–Ω–∫—Ç–∞–º–∏ ‚Äî –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ `current_tick` –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è, —Ç–∞–∫—Ç –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ. –ß–∞—Å—Ç–∏—á–Ω–æ –∑–∞–ø–∏—Å–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ã.

---

## 7. –ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

### –ò–µ—Ä–∞—Ä—Ö–∏—è –≤—ã–∑–æ–≤–æ–≤

- **CLI** ‚Äî —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞, –≤—ã–∑—ã–≤–∞–µ—Ç Runner
  - **Runner** ‚Äî –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è —Ç–∞–∫—Ç–∞, –≤—ã–∑—ã–≤–∞–µ—Ç —Ñ–∞–∑—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
    - **Phase 1** ‚Äî —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏–π, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç LLM Client
    - **Phase 2a** ‚Äî —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Å—Ü–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç LLM Client
    - **Phase 2b** ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞—Ä—Ä–∞—Ç–∏–≤–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç LLM Client
    - **Phase 3** ‚Äî –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–±–µ–∑ LLM)
    - **Phase 4** ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç LLM Client

### –û–±—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω—è—Ö:

- **LLM Client** ‚Äî –∏—Å–ø–æ–ª—å–∑—É—é—Ç Phase 1, 2a, 2b, 4
- **Storage** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Runner (–∑–∞–≥—Ä—É–∑–∫–∞/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è)
- **Narrators** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Runner (–≤—ã–≤–æ–¥ –ø–æ—Å–ª–µ —Ç–∞–∫—Ç–∞)
- **Config** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç CLI –∏ Runner (–ø–∞—Ä–∞–º–µ—Ç—Ä—ã, —Ä–µ–∑–æ–ª–≤ –ø—Ä–æ–º–ø—Ç–æ–≤)

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –§–∞–π–ª | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å |
|-----------|------|-----------------|
| CLI | `cli.py` | –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, –ø–∞—Ä—Å–∏—Ç –∞—Ä–≥—É–º–µ–Ω—Ç—ã, –≤—ã–∑—ã–≤–∞–µ—Ç Runner |
| Config | `config.py` | –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, PhaseConfig, —Ä–µ–∑–æ–ª–≤ –ø—Ä–æ–º–ø—Ç–æ–≤ |
| Runner | `runner.py` | –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è —Ç–∞–∫—Ç–∞, –≤—ã–∑—ã–≤–∞–µ—Ç —Ñ–∞–∑—ã 1‚Üí2a‚Üí2b‚Üí3‚Üí4, –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å |
| Phase Common | `phases/common.py` | –û–±—â–∏–µ —Ç–∏–ø—ã –¥–ª—è —Ñ–∞–∑ (PhaseResult) |
| Phase 1 | `phases/phase1.py` | –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏–π –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π |
| Phase 2a | `phases/phase2a.py` | –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Å—Ü–µ–Ω—ã –∞—Ä–±–∏—Ç—Ä–æ–º |
| Phase 2b | `phases/phase2b.py` | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞—Ä—Ä–∞—Ç–∏–≤–∞ |
| Phase 3 | `phases/phase3.py` | –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–±–µ–∑ LLM) |
| Phase 4 | `phases/phase4.py` | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π |
| LLM Client | `utils/llm.py` | –ü—Ä–æ–≤–∞–π–¥–µ—Ä-–∞–≥–Ω–æ—Å—Ç–∏—á–Ω—ã–π —Ñ–∞—Å–∞–¥, batch execution, chains |
| LLM Errors | `utils/llm_errors.py` | –ò–µ—Ä–∞—Ä—Ö–∏—è –æ—à–∏–±–æ–∫ LLM |
| LLM Adapter Base | `utils/llm_adapters/base.py` | –û–±—â–∏–µ —Ç–∏–ø—ã: AdapterResponse, ResponseUsage |
| OpenAI Adapter | `utils/llm_adapters/openai.py` | –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –¥–ª—è OpenAI Responses API |
| Prompt Renderer | `utils/prompts.py` | –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ Jinja2 –ø—Ä–æ–º–ø—Ç–æ–≤ |
| Storage | `utils/storage.py` | –ß—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å —Å–∏–º—É–ª—è—Ü–∏–∏ |
| Exit Codes | `utils/exit_codes.py` | –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–æ–¥—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è |
| Narrators | `narrators.py` | –í—ã–≤–æ–¥: console, telegram, web |
| TickLogger | `tick_logger.py` | –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∏–∫–æ–≤ –≤ markdown |

### –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –º–æ–¥—É–ª–µ–π

| –¢–∏–ø | –ú–æ–¥—É–ª–∏ | –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Å–ø–µ–∫ |
|------|---------|------------------|
| **Phase** | `phase_*.py` | Data Flow, LLM Integration (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) |
| **Core** | `cli.py`, `config.py`, `runner.py`, `narrators.py` | –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ |
| **Utils** | `utils/*.py` | –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ |

### –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –º–æ–¥—É–ª–µ–π

–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `docs/specs/`, –∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–æ —Ç–∏–ø—É –º–æ–¥—É–ª—è (phase_, core_, util_).

–ì–∞–π–¥ –ø–æ –Ω–∞–ø–∏—Å–∞–Ω–∏—é —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–π: [Thing' Sandbox Specs Writing Guide.md](Thing'%20Sandbox%20Specs%20Writing%20Guide.md)

---

## 8. –°—Ö–µ–º—ã –¥–∞–Ω–Ω—ã—Ö

–í—Å–µ —Å—Ö–µ–º—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `src/schemas/`.

### –ü–æ–¥—Ö–æ–¥ –∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

**JSON-—Å—Ö–µ–º—ã** (`*.schema.json`) ‚Äî —ç—Ç–æ **–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞** –¥–ª—è —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–≥–æ —á—Ç–µ–Ω–∏—è. –û–Ω–∏ –æ–ø–∏—Å—ã–≤–∞—é—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö, –Ω–æ –∫–æ–¥ –∏—Ö –Ω–µ —á–∏—Ç–∞–µ—Ç –≤ —Ä–∞–Ω—Ç–∞–π–º–µ.

**–í–∞–ª–∏–¥–∞—Ü–∏—è –≤ —Ä–∞–Ω—Ç–∞–π–º–µ** –∏–¥—ë—Ç —á–µ—Ä–µ–∑ **Pydantic –º–æ–¥–µ–ª–∏**, –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –≤ –∫–æ–¥–µ:
- –î–∞–Ω–Ω—ã–µ —Å–∏–º—É–ª—è—Ü–∏–∏: `utils/storage.py` (Character, Location, Simulation)
- –û—Ç–≤–µ—Ç—ã LLM: –≤ –∫–∞–∂–¥–æ–π —Ñ–∞–∑–µ (IntentionResponse –≤ `phase1.py`, –∏ —Ç.–¥.)

**–ü–æ—á–µ–º—É —Ç–∞–∫:**
- OpenAI SDK –ø—Ä–∏–Ω–∏–º–∞–µ—Ç Pydantic –º–æ–¥–µ–ª–∏ –Ω–∞–ø—Ä—è–º—É—é –¥–ª—è structured output
- Pydantic –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç JSON Schema –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º
- –ò–∑–±–µ–≥–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

**–ü—Ä–∞–≤–∏–ª–æ:** –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö ‚Äî –æ–±–Ω–æ–≤–ª—è–π –∏ Pydantic –º–æ–¥–µ–ª—å –≤ –∫–æ–¥–µ, –∏ JSON-—Å—Ö–µ–º—É –≤ `src/schemas/` –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.

### –î–∞–Ω–Ω—ã–µ —Å–∏–º—É–ª—è—Ü–∏–∏

| –°—Ö–µ–º–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-------|------------|
| `Character.schema.json` | –ü–µ—Ä—Å–æ–Ω–∞–∂: identity, state, memory |
| `Location.schema.json` | –õ–æ–∫–∞—Ü–∏—è: identity, state, connections |

–≠—Ç–∏ —Å—Ö–µ–º—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `additionalProperties: true` ‚Äî –≥–∏–±–∫–æ—Å—Ç—å –¥–ª—è –º–µ—Ç—ã, –æ—Ç–ª–∞–¥–∫–∏, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π.

### –û—Ç–≤–µ—Ç—ã LLM

| –°—Ö–µ–º–∞ | –§–∞–∑–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-------|------|------------|
| `IntentionResponse.schema.json` | 1 | –ù–∞–º–µ—Ä–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ |
| `Master.schema.json` | 2a | –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Å—Ü–µ–Ω—ã –∞—Ä–±–∏—Ç—Ä–æ–º |
| `NarrativeResponse.schema.json` | 2b | –ù–∞—Ä—Ä–∞—Ç–∏–≤ –¥–ª—è –ª–æ–≥–∞ |
| `SummaryResponse.schema.json` | 4 | –°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏ |

–≠—Ç–∏ —Å—Ö–µ–º—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `additionalProperties: false` ‚Äî —Å—Ç—Ä–æ–≥–∏–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç, –≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ OpenAI structured output.

---

## 9. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

| –§–∞–π–ª | –ß—Ç–æ —Ö—Ä–∞–Ω–∏—Ç | –ü—Ä–∏–º–µ—Ä |
|------|------------|--------|
| `.env` | –°–µ–∫—Ä–µ—Ç—ã | `OPENAI_API_KEY`, `TELEGRAM_TOKEN` |
| `config.toml` | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã LLM, –¥–µ—Ñ–æ–ª—Ç—ã —Å–∏–º—É–ª—è—Ü–∏–∏ |
| `simulation.json` | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∏–º—É–ª—è—Ü–∏–∏ | `current_tick`, `status` |

### config.toml

–ì–ª–æ–±–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞. –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `src/config.py` (Pydantic Settings).

–°–µ–∫—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥–∞:
- `[simulation]` ‚Äî –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∏–º—É–ª—è—Ü–∏–π (memory_cells –∏ –¥—Ä.)
- `[phase1]`, `[phase2a]`, `[phase2b]`, `[phase4]` ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä—ã LLM –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã

### PhaseConfig

–ö–∞–∂–¥–∞—è —Ñ–∞–∑–∞ —Å LLM –∏–º–µ–µ—Ç —Å–≤–æ—é —Å–µ–∫—Ü–∏—é –∫–æ–Ω—Ñ–∏–≥–∞. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∫–ª—é—á–∞—é—Ç: model, timeout, max_retries, reasoning_effort, response_chain_depth –∏ –¥—Ä.

–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: [LLM Approach v2 ‚Üí –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è](Thing'%20Sandbox%20LLM%20Approach%20v2.md#11-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)

### –†–µ–∑–æ–ª–≤ –ø—Ä–æ–º–ø—Ç–æ–≤

Config –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é —Ä–µ–∑–æ–ª–≤–∞ –ø—Ä–æ–º–ø—Ç–æ–≤:

1. –ò—â–µ–º `simulations/{sim-id}/prompts/{prompt}.md`
2. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –±–µ—Ä—ë–º `src/prompts/{prompt}.md`

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å —Å—Ç–∏–ª—å –Ω–∞—Ä—Ä–∞—Ç–∏–≤–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏.

---

## 10. –ö–æ–¥—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (Exit Codes)

–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–æ–¥—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–ª—è CLI. –ü–æ–ª–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è: [util_exit_codes.md](specs/util_exit_codes.md)

| –ö–æ–¥ | –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å |
|-----|----------|--------------------|
| 0 | `EXIT_SUCCESS` | –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ |
| 1 | `EXIT_CONFIG_ERROR` | –ù–µ—Ç API key, –±–∏—Ç—ã–π config.toml |
| 2 | `EXIT_INPUT_ERROR` | –ë–∏—Ç—ã–µ JSON –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π/–ª–æ–∫–∞—Ü–∏–π, –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Å—Ö–µ–º—ã |
| 3 | `EXIT_RUNTIME_ERROR` | LLM –≤–µ—Ä–Ω—É–ª –º—É—Å–æ—Ä –ø–æ—Å–ª–µ retry, –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è |
| 4 | `EXIT_API_LIMIT_ERROR` | Rate limits OpenAI |
| 5 | `EXIT_IO_ERROR` | –ù–µ —Å–º–æ–≥ –∑–∞–ø–∏—Å–∞—Ç—å –≤ simulations/ |

---

## 11. –§–æ—Ä–º–∞—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

–í—Å–µ –º–æ–¥—É–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –º–æ–¥—É–ª—å `logging` —Å –µ–¥–∏–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º –≤—ã–≤–æ–¥–∞ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏.

### –§–æ—Ä–º–∞—Ç —Å—Ç—Ä–æ–∫–∏

```
YYYY.MM.DD HH:MM:SS | LEVEL   | üè∑Ô∏è module: message
‚îú‚îÄ‚îÄ 19 —Å–∏–º–≤–æ–ª–æ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ 7 —Å–∏–º–≤ ‚îÄ‚î§ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
```

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**

```
2025.06.05 14:32:07 | INFO    | ‚öôÔ∏è config: Loaded from /path/to/config.toml
2025.06.05 14:32:07 | INFO    | üé¨ runner: Starting tick 42 for demo-sim
2025.06.05 14:32:08 | INFO    | üé≠ phase1: Processing 2 characters
2025.06.05 14:32:09 | INFO    | üé≠ phase1: Ogilvy ‚Üí "Approach the cylinder cautiously"
2025.06.05 14:32:09 | WARNING | üé≠ phase1: Henderson fallback to idle (invalid location)
2025.06.05 14:32:10 | INFO    | ü§ñ llm: Batch complete (2 requests, 450 tokens)
2025.06.05 14:32:10 | WARNING | ü§ñ llm: Rate limit hit, retry 1/3 in 2s
2025.06.05 14:32:15 | INFO    | üíæ storage: Saved demo-sim (tick 42)
2025.06.05 14:32:15 | INFO    | üé¨ runner: Tick 42 complete (8.2s)
```

### –≠–º–æ–¥–∑–∏ –ø–æ –º–æ–¥—É–ª—è–º

| –≠–º–æ–¥–∑–∏ | –ú–æ–¥—É–ª—å | –û–±–ª–∞—Å—Ç—å |
|--------|--------|---------|
| ‚öôÔ∏è | config | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è |
| üé¨ | runner | –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è —Ç–∏–∫–æ–≤ |
| üé≠ | phase1 | –ù–∞–º–µ—Ä–µ–Ω–∏—è |
| ‚öñÔ∏è | phase2a | –ê—Ä–±–∏—Ç—Ä–∞–∂ |
| üìñ | phase2b | –ù–∞—Ä—Ä–∞—Ç–∏–≤ |
| üîß | phase3 | –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ |
| üß† | phase4 | –ü–∞–º—è—Ç—å |
| ü§ñ | llm | LLM –∫–ª–∏–µ–Ω—Ç –∏ –∞–¥–∞–ø—Ç–µ—Ä—ã |
| üíæ | storage | –ß—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å |
| üì¢ | narrators | –í—ã–≤–æ–¥ |
| üìù | prompts | –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø—Ä–æ–º–ø—Ç–æ–≤ |

### –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

| –£—Ä–æ–≤–µ–Ω—å | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å |
|---------|--------------------|
| DEBUG | –î–µ—Ç–∞–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏–π (—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–ø—Ä–æ—Å–æ–≤, chain ops) |
| INFO | –ö–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è (tick start/end, phase complete, save) |
| WARNING | Recoverable issues (fallback, retry, missing optional data) |
| ERROR | –ü–µ—Ä–µ–¥ –≤—ã–±—Ä–æ—Å–æ–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è |

### –ü—Ä–∞–≤–∏–ª–∞

- **–¢–æ–ª—å–∫–æ logging, –±–µ–∑ print()** ‚Äî –≤–µ—Å—å user-facing –≤—ã–≤–æ–¥ —á–µ—Ä–µ–∑ logging —Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º console handler
- **Logger —Å–æ–∑–¥–∞—ë—Ç—Å—è** –∫–∞–∫ `logger = logging.getLogger(__name__)`
- **–°–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ —Ç–æ—á–∫–∏ –≤ –∫–æ–Ω—Ü–µ** ‚Äî `"Loaded config"`, –Ω–µ `"Loaded config."`
- **–ö–æ–Ω—Ç–µ–∫—Å—Ç –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏** ‚Äî –≤–∫–ª—é—á–∞—Ç—å entity id, file path, –º–µ—Ç—Ä–∏–∫–∏ –≥–¥–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ

---

## 12. –ü–æ—Ç–æ–∫ —Ç–∞–∫—Ç–∞: —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

–õ–æ–≥–∏–∫–∞ —Ñ–∞–∑ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–∞–∫—Ç–∞ –æ–ø–∏—Å–∞–Ω—ã –≤ [Concept](Thing'%20Sandbox%20Concept.md#2-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-—Ç–∞–∫—Ç–∞-—á–µ—Ç—ã—Ä–µ-—Ñ–∞–∑—ã). –ó–¥–µ—Å—å ‚Äî —Ç–æ–ª—å–∫–æ –º–∞–ø–ø–∏–Ω–≥ –Ω–∞ —Å—Ö–µ–º—ã –¥–∞–Ω–Ω—ã—Ö.

| –§–∞–∑–∞ | –ó–∞–ø—Ä–æ—Å–æ–≤ | –°—Ö–µ–º–∞ –æ—Ç–≤–µ—Ç–∞ LLM |
|------|----------|------------------|
| 1 ‚Äî –ù–∞–º–µ—Ä–µ–Ω–∏—è | N | `IntentionResponse.schema.json` |
| 2a ‚Äî –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ | L | `Master.schema.json` |
| 2b ‚Äî –ù–∞—Ä—Ä–∞—Ç–∏–≤ | L | `NarrativeResponse.schema.json` |
| 3 ‚Äî –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ | 0 | ‚Äî (–º–µ—Ö–∞–Ω–∏–∫–∞) |
| 4 ‚Äî –ü–∞–º—è—Ç—å | N | `SummaryResponse.schema.json` |

---

## 13. –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### –Ø–∑—ã–∫ –∏ —Ä–∞–Ω—Ç–∞–π–º

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –†–µ—à–µ–Ω–∏–µ |
|-----------|---------|
| –Ø–∑—ã–∫ | Python 3.11+ |
| –ú–µ–Ω–µ–¥–∂–µ—Ä –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π | pip + requirements.txt |
| –¢–∏–ø–∏–∑–∞—Ü–∏—è | Type hints + mypy |

### –û—Å–Ω–æ–≤–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

| –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ | –ó–∞—á–µ–º |
|------------|------------|-------|
| CLI | typer | –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π CLI —Å type hints |
| –í–∞–ª–∏–¥–∞—Ü–∏—è/–º–æ–¥–µ–ª–∏ | Pydantic v2 | –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö, –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥–æ–≤ |
| LLM | openai (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π SDK) | Structured output –∏–∑ –∫–æ—Ä–æ–±–∫–∏ |
| –®–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤ | Jinja2 | –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø—Ä–æ–º–ø—Ç–æ–≤ —Å –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞–º–∏ |
| Web-—Å–µ—Ä–≤–µ—Ä | FastAPI | Async, websockets, Pydantic-native |
| Telegram | python-telegram-bot | –ó—Ä–µ–ª–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: aiogram) |

### Dev-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

| –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç |
|------------|------------|
| –¢–µ—Å—Ç—ã | pytest |
| –¢–∏–ø—ã | mypy |
| –õ–∏–Ω—Ç–µ—Ä/—Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä | ruff |

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

| –¢–∏–ø | –§–æ—Ä–º–∞—Ç | –ì–¥–µ |
|-----|--------|-----|
| –°–µ–∫—Ä–µ—Ç—ã | .env | OPENAI_API_KEY, TELEGRAM_TOKEN |
| –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è | config.toml | src/config.py (Pydantic Settings) |
| –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∏–º—É–ª—è—Ü–∏–∏ | simulation.json | simulations/{id}/simulation.json |

### –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –≤—ã–≤–æ–¥–∞

| –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å | –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–∏–ø | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|-----------|-----------|-----|----------|
| Console | Narrator | pull (print) | MVP |
| TickLogger | Logger | write (markdown) | MVP |
| Telegram | Narrator | push | –ø–æ—Å–ª–µ MVP |
| Web | Narrator | push (websocket) | –ø–æ—Å–ª–µ MVP |

---

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –î–æ–∫—É–º–µ–Ω—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ –º–µ—Ä–µ —Ä–∞–∑–≤–∏—Ç–∏—è –ø—Ä–æ–µ–∫—Ç–∞
- –î–µ—Ç–∞–ª–∏ —Ä–∞–±–æ—Ç—ã —Å LLM: [Thing' Sandbox LLM Approach v2.md](Thing'%20Sandbox%20LLM%20Approach%20v2.md)
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è LLM: [Thing' Sandbox LLM Usage Tracking.md](Thing'%20Sandbox%20LLM%20Usage%20Tracking.md)
- –î–µ—Ç–∞–ª–∏ —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–º–ø—Ç–∞–º–∏: [Thing' Sandbox LLM Prompting.md](Thing'%20Sandbox%20LLM%20Prompting.md)
- –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –º–æ–¥—É–ª–µ–π: `docs/specs/`
