# Thing' Sandbox: Концепция проекта

## Общая концепция

Текстовая игровая симуляция в стиле D&D/MUD, где персонажи управляются LLM и автономно взаимодействуют друг с другом и миром. Бесконечная симуляция с возможностью наблюдения и влияния.

Цель — sandbox для исследования поведения LLM-агентов и интересный эксперимент для небольшой компании друзей.

---

## Словарь терминов

- **Персонаж** (актор) - Автономная сущность, управляемая LLM. Имеет характер, память, текущее состояние
- **Гейм-мастер** (арбитр) - LLM в роли ведущего, разрешает сцены в локации
- **Такт** (тик) - Один дискретный шаг симуляции, включает все 4 фазы
- **Локация** — Место в мире, где могут находиться персонажи и объекты
- **Сцена** — События в одной локации за один такт
- **Намерение** — Желаемое действие персонажа, сформированное в фазе 1
- **Нарратив** — Человекочитаемое описание событий сцены
- **Память** — Субъективные воспоминания персонажа, организованные как FIFO-очередь

---

## 1. Концепция времени

- Каждый такт = один полный цикл из 4 фаз
- Запуск тактов: по расписанию (авто) или по команде (ручной режим)
- Симуляция работает пока не остановлена вручную

---

## 2. Структура такта (четыре фазы)

Для N персонажей и L локаций каждый такт возникает L сцен — в каждой локации, независимо от наличия персонажей. Мир живёт везде: костёр догорает, дождь идёт, яблоко гниёт.

### Фаза 1: Формирование намерений (персонажи)

**N запросов** — по одному на каждого персонажа.

**Входные данные:**
- Промпт персонажа (постоянная + изменяемая часть)
- Описание текущей локации и видимого мира
- Память персонажа (K ячеек + Summary)

**Выходные данные:**
- Намерение действия (что персонаж хочет сделать)

### Фаза 2: Разрешение сцен (гейм-мастер)

**L запросов** — по одному на каждую локацию.

**Входные данные:**
- Все намерения персонажей в локации
- Описание мира/локации
- Контекст предыдущих событий
- Характеры и триггеры персонажей

**Ответственности гейм-мастера:**
- Определить порядок событий (что произошло раньше)
- Разрулить конфликты между намерениями
- Учесть триггеры персонажей (реакции на обращение, опасность и т.п.)
- Определить успех, частичный успех или неудачу действий
- Сгенерировать интересный нарратив
- Сформировать субъективные записи для памяти каждого участника сцены

**Выходные данные (два отдельных запроса к LLM):**
1. **Структура** — JSON с изменениями для системы (позиции, состояния, инвентарь, записи в память)
2. **Нарратив** — человекочитаемое описание для лога наблюдателя (JSON структура + контекст → нарратив)

### Фаза 3: Применение результатов

**0 запросов** — чистая механика, без LLM.

**Обновление состояния на основе JSON из фазы 2:**
- Описание локации (если изменилось)
- Состояния персонажей (позиция, internal_state, external_intent)
- Записи для памяти персонажей

### Фаза 4: Обновление памяти

**N запросов** — по одному на каждого персонажа.

**Операции с памятью:**
- Суммаризировать summary с выпадающей ячейкой K (LLM-запрос)
- Сдвинуть ячейки (FIFO)
- Добавить новое событие в ячейку 1

При суммаризации LLM сжимает историю, сохраняя ключевые события. Старые события могут размываться и искажаться.

---

## 3. Стоимость такта

```
Фаза 1:  N запросов (намерения персонажей)
Фаза 2:  2xL запросов (разрешение сцен по локациям и генерация нарративов)
Фаза 3:  0 запросов (механика)
Фаза 4:  N запросов (суммаризация памяти)

Итого: 2N + 2L запросов за такт
```

Где N — количество персонажей, L — количество локаций (все, не только с персонажами).

---

## 4. Система памяти персонажей

### Структура памяти

У каждого персонажа **своя** память — FIFO-очередь из K детальных ячеек + summary:

```
Ячейка 1: [последний такт]  — детальная память
Ячейка 2: [предыдущий такт] — детальная память
...
Ячейка K: [такт ...]        — детальная память
Summary:  [всё раньше]      — сжатая/размытая память
```

### Содержимое памяти

Память включает не только факты, но и субъективный опыт:
- Что персонаж **пытался** сделать
- Что **получилось** (успех, неудача, неожиданный результат)
- Как персонаж это **интерпретирует**

Пример плохой записи: «Боб ушёл»
Пример хорошей записи: «Я попытался поговорить с Бобом, но он ушёл не ответив — похоже, он меня избегает»

### Разделение памяти и мира

**Описание мира** (объективное):
- Факты: что есть в локации, состояние объектов
- Хранится отдельно, не искажается

**Память персонажа** (субъективное):
- Интерпретация событий с точки зрения персонажа
- Может искажаться и размываться со временем
- У разных персонажей — разная память об одних событиях

---

## 5. Система персонажей

### Структура персонажа

**Постоянная часть (identity):**
- id — уникальный идентификатор
- name — имя персонажа
- description — характер, ценности, паттерны поведения
- triggers — триггеры реакций

**Изменяемая часть (state):**
- location — текущая локация
- internal_state — внутреннее состояние (эмоции, самочувствие)
- external_intent — внешние намерения (цели, фокус)

### Триггеры как часть характера

Триггеры — не отдельная механика, а часть описания персонажа. Примеры:
- «Если кто-то обращается — отвечаю прежде чем продолжить своё дело»
- «При опасности — сначала оцениваю, потом действую»
- «Не могу пройти мимо несправедливости»

Гейм-мастер учитывает триггеры при разрешении сцены.

---

## 6. Топология мира

### Стартовая структура

Простая топология для начала:
- Линейная цепочка локаций (A → B → C)
- Или простое поле X×Y локации

### Особенности

- Персонажи могут перемещаться между локациями
- Описание каждой локации хранится отдельно
- Детали механики перемещения — через намеренье персонажа на фазе 1

---

## 7. Режим взаимодействия

### Наблюдение (основной режим)

- Чтение нарратива каждого такта
- Пассивное наблюдение за симуляцией

### Влияние (опциональное)

- Возможность вмешаться в мир
- Механика влияния — определим позже

---

## 8. Персистентность

### Сохранение состояния

Симуляция полностью восстанавливается из:
- Описания мира (состояние всех локаций)
- Памяти каждого персонажа (K ячеек)
- Промптов персонажей (постоянная + изменяемая части)

### Свойства

- Симуляция бесконечна
- Можно продолжить с любого сохранённого момента
- Останавливается только вручную

---

## 9. Поток одного такта (итоговая схема)

```
1. Такт начался
   ↓
2. Фаза 1 — Намерения (N запросов):
   Для каждого персонажа:
   - Собрать контекст (промпт + мир + память)
   - LLM генерирует намерение
   ↓
3. Фаза 2 — Разрешение (2×L запросов):
   Для каждой локации:
   - LLM-арбитр получает намерения + контекст
   - Определяет порядок, конфликты, успехи/неудачи
   - Выдаёт JSON с изменениями
   - LLM-рассказчик генерирует нарратив по JSON
   ↓
4. Фаза 3 — Применение (0 запросов):
   - Обновить описание мира
   - Обновить состояния персонажей
   - Обновить изменяемую часть промптов
   ↓
5. Фаза 4 — Память (N запросов):
   Для каждого персонажа:
   - Суммаризировать summary с выпадающей ячейкой K
   - Сдвинуть ячейки (FIFO)
   - Добавить новое событие в ячейку 1
   ↓
6. Вывод нарратива для наблюдателя (формируется на фазе 2)
   ↓
7. Следующий такт (или пауза)
```

---

## 10. Ключевые принципы

1. **LLM-гейм-мастер как сердце системы** — творческое разрешение ситуаций, не жёсткие правила
2. **Субъективная память** — у каждого своя интерпретация событий
3. **Адаптация через память** — персонажи учатся на прошлых тактах, не в моменте
4. **Триггеры как характер** — реактивность через описание, не через механику
5. **Простота старта** — минимальная топология, расширяем по необходимости
6. **Нарратив отдельно от данных** — человекочитаемый лог + машиночитаемый JSON
