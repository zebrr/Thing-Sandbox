# Thing' Sandbox — Гайд по созданию симуляций

Этот документ описывает, как создать симуляцию для Thing' Sandbox: от концепции до готовых файлов.

---

## 1. Концепция симуляции

Прежде чем писать JSON и промпты, ответь на вопросы:

**Идея** — одно предложение, суть эксперимента.
> "Астроном и журналист у марсианского цилиндра в викторианской Англии"
> или
> "Одинокий ИИ летит к звёздам 800 лет и размышляет о смысле"

**Жанр и атмосфера** — какое настроение создаём?
- Sci-fi horror с нарастающим напряжением
- Созерцательная философская медитация
- Нуарный детектив
- Бытовая драма с элементами абсурда

**Главный вопрос** — что хотим увидеть/исследовать?
- Как люди реагируют на непознаваемое?
- Может ли ИИ развить что-то похожее на душу?
- Как конфликт интересов разрушает дружбу?

**Темпоральность** — что такое один тик?
- Минуты (напряжённая сцена)
- Часы (день из жизни)
- Дни (эпизодическая история)
- Годы (эпическое путешествие)

Темпоральность влияет на всё: как пишутся воспоминания, насколько детальны действия, какой объём нарратива уместен.

**Длительность** — конечная или бесконечная?

Бесконечная симуляция идёт пока интересно, каждый тик самодостаточен. Конечная — движется к финалу.

Если конечная, продумай заранее:
- Примерное число тиков
- Ожидаемый образ результата — чем должна закончиться история? (победитель определён, тайна раскрыта, катастрофа произошла, герои изменились)

---

## 2. Сеттинг

Сеттинг — это не один текст, а **три слоя информации**, распределённых по промптам разных фаз.

### Поверхностный слой → phase1 (персонаж)

Что персонажи знают и видят. Может содержать заблуждения, слухи, неполную картину.

> "Слухи о жизни на Марсе ходят в научных кругах, но большинство считает это фантазией."

### Полный слой → phase2a (арбитр)

Скрытая правда и правила мира. Арбитр знает всё и использует это для разрешения сцен.

> "Марсиане существуют и они здесь. Их цивилизация умирает — Марс холодеет, ресурсы истощены. Технологии марсиан превосходят земные на столетия: тепловой луч испаряет людей мгновенно."

### Атмосферный слой → phase2b (нарратор)

Тон повествования, что показывать и как. Нарратор может знать правду, но раскрывает только то, что уместно.

> "Жанр: научно-фантастический хоррор в духе Уэллса. Напряжение строится через детали: странные звуки, незнакомые запахи, неправильные формы."

### Как распределять информацию

| Что | Куда |
|-----|------|
| Время, место, базовый контекст | Все три промпта |
| Что персонажи знают/верят | phase1 |
| Скрытые механики, тайны, "физика" мира | phase2a |
| Жанровые конвенции, стиль, ограничения | phase2b |

---

## 3. Персонажи

Структура персонажа (см. `src/schemas/Character.schema.json`):

### identity — кто это (статика, не меняется)

```json
{
  "id": "ogilvy",
  "name": "Огилви",
  "description": "Известный астроном, человек науки до мозга костей. Рационален, методичен, скептически относится к сенсационным заявлениям.",
  "triggers": "При встрече с необъяснимым — ищет рациональное объяснение. При опасности — колеблется между любопытством и осторожностью."
}
```

- **id** — уникальный идентификатор, lowercase с подчёркиваниями
- **name** — отображаемое имя
- **description** — характер, ценности, паттерны поведения (идёт в системный промпт)
- **triggers** — автоматические реакции на определённые ситуации

### state — текущая ситуация (динамика, меняется каждый тик)

```json
{
  "location": "woking_common",
  "internal_state": "Возбуждён открытием, но тревожит странный звук изнутри цилиндра",
  "external_intent": "Изучить цилиндр, понять его природу, организовать научную экспедицию"
}
```

- **location** — id текущей локации
- **internal_state** — внутренние ощущения: устал, голоден, тревожен, счастлив
- **external_intent** — цели и фокус: что персонаж хочет сделать

### memory — субъективные воспоминания

```json
{
  "cells": [
    {
      "tick": -1,
      "text": "Нашёл. Это не метеорит — это цилиндр. Огромный, тридцать ярдов..."
    }
  ],
  "summary": "Тридцать лет наблюдений, две публикации в «Astronomical Journal»..."
}
```

- **cells** — недавние воспоминания (FIFO очередь), index 0 = самое свежее
- **summary** — сжатая история всего, что было до oldest cell

### Советы по созданию персонажей

**Конфликт внутри** — интересный персонаж имеет противоречия. Огилви: любопытство vs осторожность. Хендерсон: цинизм vs жажда признания.

**Триггеры создают драму** — они определяют, когда персонаж действует "на автомате", против своих интересов или рационального выбора.

**Предыстория в summary** — не просто факты, а эмоциональный багаж. Не "работает журналистом 15 лет", а "15 лет в газетном деле, и что я имею? Долги, комнату в пансионе и репутацию человека, который напишет что угодно за пять фунтов."

**Начальные воспоминания (cells с отрицательными tick)** — можно создать 1-2 воспоминания "до начала симуляции", чтобы персонаж пришёл с контекстом.

---

## 4. Локации

Структура локации (см. `src/schemas/Location.schema.json`):

### identity — что это за место (статика)

```json
{
  "id": "horsell_pit",
  "name": "Песчаная яма Хорселла",
  "description": "Заброшенный песчаный карьер, глубокая воронка с осыпающимися стенами. В центре лежит ОНО — огромный цилиндр около тридцати ярдов в диаметре.",
  "connections": [
    {
      "location_id": "woking_common",
      "description": "Тропинка вверх по склону на пустошь Уокинг-коммон"
    }
  ]
}
```

- **id** — уникальный идентификатор
- **name** — отображаемое название
- **description** — что здесь есть, накапливает значимые изменения
- **connections** — куда можно попасть отсюда

### state — текущий момент (динамика)

```json
{
  "moment": "Песчаные стены ямы отбрасывают длинные вечерние тени. Цилиндр лежит в центре — огромный, серый, всё ещё тёплый на ощупь. Верхняя часть медленно откручивается с металлическим скрежетом."
}
```

- **moment** — что происходит прямо сейчас: временные условия, атмосфера, ambient state

### Топология: граф связей

Локации образуют граф. Связи могут быть:
- Двусторонними (тропинка туда-обратно)
- Односторонними (спрыгнул с обрыва — обратно не залезешь)
- Условными (дверь заперта, нужен ключ) — это решает арбитр

Для простых симуляций достаточно 2-3 локаций. Для сложных — продумай, как персонажи могут перемещаться и встречаться.

---

## 5. Арбитр

Арбитр (phase2a) — Game Master симуляции. Он знает всю правду о мире и решает, что реально происходит на основе намерений персонажей.

### Роль арбитра

- Разрешает намерения персонажей: успех, частичный успех, неудача
- Учитывает триггеры и личности при конфликтах
- Пишет memory_entry от первого лица персонажа
- Обновляет moment локации
- **Вносит внешние события**, даже если персонаж их не просил

### Палитра событий

Для каждой симуляции полезно заготовить палитру возможных событий — набор вещей, которые могут случиться с персонажами или в мире. Разбей их по категориям:

- **Внешние события** — что происходит в мире независимо от персонажей
- **Социальные события** — встречи, конфликты, новости
- **Внутренние события** — сбои, находки, изменения состояния
- **Фоновые события** — погода, время суток, атмосфера

### Баланс и инъекция событий

Персонажи формулируют намерения, но арбитр делает мир живым. Без внешних событий симуляция превращается в монолог.

**Правило инъекции:** если 2-3 тика подряд прошли без внешних событий (только внутренние размышления, рутина, диалоги), арбитр должен вбросить что-то из палитры — даже если персонаж этого не просил.

Пропиши это явно в промпте арбитра:

```
## Event Injection Rule

If 2+ ticks passed with only internal/routine content, inject one external 
event from the palette this tick. The world happens TO characters, not just 
around their intentions.
```

### Длина memory_entry

Memory_entry — это то, что персонаж запомнит о тике. Модели склонны писать длинные эссе, если не ограничить.

**Рекомендация:** 3-5 предложений, одно ключевое событие или осознание. Детали и рутина забываются.

Пропиши в промпте:

```
- Keep memory_entry concise: 3-5 sentences capturing the most significant 
  moment or realization; routine and details can be forgotten
```

### Драматическая структура (конечные симуляции)

Если симуляция имеет финал, пропиши в системном промпте арбитра:
- Общее число тиков
- Что является финалом (развязка конфликтов, подсчёт, решающее событие)
- Когда начинается финальная фаза (обычно последние 2-3 тика)

Общий принцип: первая половина — установка и эскалация, вторая — кульминация и развязка.

В финальной фазе арбитр должен:
- Разрешать существующие конфликты, не создавать новые крупные
- Давать долгосрочным стратегиям персонажей проявить результаты
- Подводить к ясному исходу

---

## 6. Нарратор

Нарратор (phase2b) превращает решения арбитра в историю. Его промпт определяет:

### Стиль и лицо

- От третьего лица (стандарт)
- Литературный / разговорный / поэтичный
- Показывать, не рассказывать (show, don't tell)

### Объём

Указывай конкретно:
> "1-2 абзаца по 2-3 предложения (не более 6 предложений всего)"
> "4-6 коротких предложений в 1-2 абзацах"
> "Если мало событий — 1-3 предложения"

### Фокус

Что показывать:
- Действия и их последствия
- Детали окружения (запахи, звуки, текстуры)
- Реакции персонажей через поведение

Что скрывать:
- Внутренние мысли напрямую (только через действия)
- События за пределами тика
- Информацию, которую персонажи не могут знать

### Особые правила для жанра

Примеры из существующих симуляций:

**Sci-fi horror:**
> "Напряжение строится через детали: странные звуки, незнакомые запахи, неправильные формы, реакции животных."

**Философская медитация:**
> "В каждом эпизоде выделяй одну небольшую философскую мысль или сдвиг и делай её центром сцены."

---

## 7. Краткое описание (питч)

Питч — 1-2 абзаца, которые "продают" симуляцию. Структура:

### Якорь (первое предложение)
Время, место, ситуация — сразу погружаем.
> "Англия, лето 1898."
> "Год 3004. Автономный зонд ЭХО-Гамма-7 летит к звезде Лейтен уже 847 лет."

### Персонажи через конфликт
Не описание внешности, а что ими движет и почему это интересно.
> "Астроном Огилви уверен: это научная сенсация. Журналист Хендерсон чует историю, которая вернёт его в игру."

### Крючок (финал)
Вопрос или образ, который оставляет в напряжении.
> "Никто из них пока не понимает, что крышка цилиндра медленно откручивается."
> "Миссия продолжается. Но зачем?"

### Шаблон

```
[Время/место]. [Ситуация — что происходит]. [Персонаж 1 — что им движет]. [Персонаж 2 — контраст или конфликт]. [Детали атмосферы, если нужны]. [Крючок — вопрос или тревожный образ].
```

---

## 8. Чеклист создания симуляции

### Подготовка

- [ ] Сформулировать концепцию: идея, жанр, главный вопрос, темпоральность
- [ ] Придумать 1-3 персонажей с конфликтами и триггерами
- [ ] Набросать 1-3 локации и связи между ними
- [ ] Определить стиль нарратора

### Создание файлов

1. Создать папку `simulations/<sim-id>/`
2. Создать подпапки: `characters/`, `locations/`, `prompts/`, `logs/`
3. Скопировать `simulation.json` из Приложения A, заполнить id
4. Создать JSON персонажей по схеме `src/schemas/Character.schema.json`
5. Создать JSON локаций по схеме `src/schemas/Location.schema.json`
6. Скопировать промпты из `src/prompts/` и модифицировать под свой сеттинг

### Промпты для модификации

| Файл | Что менять |
|------|-----------|
| `phase1_intention_system.md` | Setting (поверхностный слой) |
| `phase1_intention_user.md` | Обычно не требует изменений |
| `phase2a_resolution_system.md` | Setting (полный слой), палитра событий, правило инъекции, лимит memory_entry |
| `phase2a_resolution_user.md` | Обычно не требует изменений |
| `phase2b_narrative_system.md` | Setting (атмосфера), Style, объём, особые правила |
| `phase2b_narrative_user.md` | Обычно не требует изменений |
| `phase4_summary_system.md` | Язык, стиль суммаризации |
| `phase4_summary_user.md` | Обычно не требует изменений |

### Проверка

- [ ] Все id уникальны и в lowercase с подчёркиваниями
- [ ] Все location в персонажах соответствуют существующим локациям
- [ ] Connections в локациях ведут на существующие id
- [ ] Промпты содержат указание языка ответа
- [ ] Написан питч симуляции

---

## Приложение A: simulation.json

Базовый шаблон конфигурации симуляции:

```json
{
  "id": "my-simulation",
  "current_tick": 0,
  "created_at": "2025-01-01T00:00:00Z",
  "status": "paused",
  "output": {
    "console": {
      "show_narratives": true
    },
    "file": {
      "enabled": true
    },
    "telegram": {
      "enabled": false,
      "chat_id": "",
      "message_thread_id": "",
      "mode": "full_stats",
      "group_intentions": true,
      "group_narratives": true
    }
  }
}
```

| Поле | Описание |
|------|----------|
| `id` | Уникальный идентификатор симуляции, совпадает с именем папки |
| `current_tick` | Текущий тик (начинать с 0) |
| `created_at` | Дата создания в ISO формате |
| `status` | Статус: `paused`, `running`, `completed` |
| `output.console.show_narratives` | Показывать нарративы в консоли |
| `output.file.enabled` | Записывать логи в файлы |
| `output.telegram.enabled` | Отправлять в Telegram |
| `output.telegram.chat_id` | ID чата Telegram (заполнить при включении) |
| `output.telegram.message_thread_id` | ID топика в супергруппе (опционально) |
