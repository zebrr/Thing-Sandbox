# TS-AUDIT-004: Code Consistency Audit

## References
- `docs/specs/core_config.md` ‚Äî Config spec
- `docs/specs/util_storage.md` ‚Äî Storage spec
- `docs/specs/util_llm.md` ‚Äî LLM Client spec
- `docs/specs/util_llm_errors.md` ‚Äî LLM Errors spec
- `docs/specs/util_prompts.md` ‚Äî Prompts spec
- All code in `src/`

## Context
–ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ across all modules. –¶–µ–ª—å ‚Äî –≤—ã—è–≤–∏—Ç—å —Ä–∞–∑–Ω–æ–±–æ–π –≤ –ø–æ–¥—Ö–æ–¥–∞—Ö –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏.

## Steps

### 1. Config Usage

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ –≤—Å–µ—Ö –º–æ–¥—É–ª—è—Ö:
- –ö–∞–∫ –ø–æ–ª—É—á–∞—é—Ç Config? (`Config.load()` vs dependency injection)
- –ö–∞–∫ –æ–±—Ä–∞—â–∞—é—Ç—Å—è –∫ –ø–æ–ª—è–º? (–ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø vs getters)
- –ï—Å—Ç—å –ª–∏ —Ö–∞—Ä–¥–∫–æ–¥ –∑–Ω–∞—á–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –∫–æ–Ω—Ñ–∏–≥–µ?

### 2. Pydantic Models

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:
- –í—Å–µ –ª–∏ –º–æ–¥–µ–ª–∏ –Ω–∞—Å–ª–µ–¥—É—é—Ç—Å—è –æ—Ç `BaseModel`?
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ `Field()` —Å –æ–ø–∏—Å–∞–Ω–∏—è–º–∏?
- Frozen/mutable ‚Äî –µ—Å—Ç—å –ª–∏ –µ–¥–∏–Ω—ã–π –ø–æ–¥—Ö–æ–¥?
- –í–∞–ª–∏–¥–∞—Ç–æ—Ä—ã ‚Äî –∫–∞–∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω—ã?

### 3. Path Handling

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ –≤—Å–µ—Ö –º–æ–¥—É–ª—è—Ö:
- `Path` vs `str` –¥–ª—è –ø—É—Ç–µ–π?
- –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ vs –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –ø—É—Ç–∏?
- –ö–∞–∫ —Å—Ç—Ä–æ—è—Ç—Å—è –ø—É—Ç–∏? (`/` operator vs `os.path.join` vs f-strings)
- –ï—Å—Ç—å –ª–∏ —Ö–∞—Ä–¥–∫–æ–¥ –ø—É—Ç–µ–π?

### 4. LLM Client Usage

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ —Ñ–∞–∑–∞—Ö:
- –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π –∏–º–ø–æ—Ä—Ç? (`from src.utils.llm import ...`)
- –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ LLMRequest?
- –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ batch?
- –ù–µ—Ç –ª–∏ –ø—Ä—è–º—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤ –∏–∑ openai?

### 5. Storage Usage

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
- –ö–∞–∫ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è load/save?
- –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏?
- –†–∞–±–æ—Ç–∞ —Å Simulation, Character, Location ‚Äî –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–∞?

### 6. Error Handling ‚ö†Ô∏è CRITICAL

**–°–æ–±—Ä–∞—Ç—å –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É:**

a) **Exception types used:**
   - –ö–∞–∫–∏–µ —Å–≤–æ–∏ exceptions –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã?
   - –ö–∞–∫–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è?
   - –ì–¥–µ raise, –≥–¥–µ catch?

b) **Error handling patterns:**
   - try/except ‚Äî —á—Ç–æ –ª–æ–≤–∏—Ç—Å—è, —á—Ç–æ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è?
   - Fallback strategies?
   - Re-raise —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∏–ª–∏ –±–µ–∑?

c) **Error messages:**
   - –§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–π?
   - –ï—Å—Ç—å –ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç (file, entity, phase)?
   - –Ø–∑—ã–∫ (English)?

### 7. Logging ‚ö†Ô∏è CRITICAL

**–°–æ–±—Ä–∞—Ç—å –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É:**

a) **Logger setup:**
   - –ö–∞–∫ —Å–æ–∑–¥–∞—ë—Ç—Å—è logger? (`logging.getLogger(__name__)`)
   - –ì–¥–µ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —É—Ä–æ–≤–µ–Ω—å/—Ñ–æ—Ä–º–∞—Ç?

b) **Log levels usage:**
   - DEBUG ‚Äî –¥–ª—è —á–µ–≥–æ?
   - INFO ‚Äî –¥–ª—è —á–µ–≥–æ?
   - WARNING ‚Äî –¥–ª—è —á–µ–≥–æ?
   - ERROR ‚Äî –¥–ª—è —á–µ–≥–æ?

c) **Log message format:**
   - –ï—Å—Ç—å –ª–∏ –µ–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å?
   - –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö?

d) **Print vs logging:**
   - –ì–¥–µ print, –≥–¥–µ logging?
   - –ï—Å—Ç—å –ª–∏ —Å–º–µ—à–µ–Ω–∏–µ?

### 8. Exit Codes Usage

–°–≤–µ—Ä–∏—Ç—å —Å `docs/specs/util_exit_codes.md`:

| Code | Constant | –î–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–æ–≥–¥–∞ |
|------|----------|-----------------------------|
| 0 | EXIT_SUCCESS | –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ |
| 1 | EXIT_CONFIG_ERROR | –ù–µ—Ç API key, –±–∏—Ç—ã–π config.toml |
| 2 | EXIT_INPUT_ERROR | –ë–∏—Ç—ã–µ JSON, –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Å—Ö–µ–º—ã |
| 3 | EXIT_RUNTIME_ERROR | LLM –º—É—Å–æ—Ä –ø–æ—Å–ª–µ retry, unexpected exceptions |
| 4 | EXIT_API_LIMIT_ERROR | Rate limits OpenAI |
| 5 | EXIT_IO_ERROR | –ù–µ —Å–º–æ–≥ –∑–∞–ø–∏—Å–∞—Ç—å –≤ simulations/ |

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
- –í—Å–µ –ª–∏ exit points –≤ CLI –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–∑ `exit_codes.py`?
- –ù–µ—Ç –ª–∏ —Ö–∞—Ä–¥–∫–æ–¥–∞ —á–∏—Å–µ–ª (`sys.exit(1)` –≤–º–µ—Å—Ç–æ `sys.exit(EXIT_CONFIG_ERROR)`)?
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ –º–∞–ø–ø—è—Ç—Å—è exceptions –Ω–∞ exit codes?
- –í—Å–µ –ª–∏ error paths –≤ CLI –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∫–æ–¥–æ–º?

### 9. Typing

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
- –í—Å–µ –ª–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Å type hints?
- `| None` vs `Optional[]`?
- Generic types ‚Äî –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã?
- `Any` ‚Äî –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ –ø–æ—á–µ–º—É?

## Testing
–ó–∞–¥–∞—á–∞ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

## Deliverables

### –§–∞–π–ª –æ—Ç—á—ë—Ç–∞: `docs/tasks/TS-AUDIT-004_REPORT.md`

–§–æ—Ä–º–∞—Ç –æ—Ç—á—ë—Ç–∞:

```markdown
# Audit Report: Code Consistency

## Summary
[–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏]

## 1. Config Usage
[Findings + —Ç–∞–±–ª–∏—Ü–∞ –ø–æ –º–æ–¥—É–ª—è–º]

## 2. Pydantic Models
[Findings + —Ç–∞–±–ª–∏—Ü–∞ –º–æ–¥–µ–ª–µ–π]

## 3. Path Handling
[Findings + –ø—Ä–∏–º–µ—Ä—ã]

## 4. LLM Client Usage
[Findings –ø–æ —Ñ–∞–∑–∞–º]

## 5. Storage Usage
[Findings]

## 6. Error Handling
### 6.1 Exception Types Inventory
[–¢–∞–±–ª–∏—Ü–∞: Exception ‚Üí –≥–¥–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω ‚Üí –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è]

### 6.2 Error Handling Patterns
[–¢–∞–±–ª–∏—Ü–∞: –º–æ–¥—É–ª—å ‚Üí pattern ‚Üí –ø—Ä–∏–º–µ—Ä]

### 6.3 Error Messages
[–ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö/–ø–ª–æ—Ö–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π]

## 7. Logging
### 7.1 Logger Setup
[–ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –∫–∞–∂–¥–æ–º –º–æ–¥—É–ª–µ]

### 7.2 Log Levels Usage
[–¢–∞–±–ª–∏—Ü–∞: —É—Ä–æ–≤–µ–Ω—å ‚Üí –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ‚Üí –¥–ª—è —á–µ–≥–æ]

### 7.3 Print vs Logging
[–ì–¥–µ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è]

## 8. Exit Codes Usage
[–¢–∞–±–ª–∏—Ü–∞: –≥–¥–µ exit ‚Üí –∫–∞–∫–æ–π –∫–æ–¥ ‚Üí –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏]

## 9. Typing
[Findings]

## ‚úÖ Consistent
[–ß—Ç–æ –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ]

## ‚ö†Ô∏è Inconsistent
[–ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏]

## ‚ùå Issues
[–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã]

## üìã Recommendations
### Quick Fixes
[–ß—Ç–æ –º–æ–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Å—Ä–∞–∑—É]

### Standards Needed
[–ì–¥–µ –Ω—É–∂–µ–Ω –µ–¥–∏–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç ‚Äî –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è]
```
