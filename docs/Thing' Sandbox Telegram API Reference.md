# Telegram Bot API Reference — Проектный гайд

## Обзор

API Telegram Bot — это HTTP-интерфейс, позволяющий отправлять сообщения, получать обновления и управлять чатами с помощью программных запросов. Все вызовы выполняются через URL `https://api.telegram.org/bot<token>/<method>` с токеном, полученным у **@BotFather**.

Этот документ описывает методы, которые пригодятся для проекта, где бот будет публиковать нарративы и получать обратную связь в группах и каналах. Методы для приложений, игр, платежей и стикеров не рассматриваются.

## 1. Авторизация и общие параметры

1. **Токен** — уникальный ключ, выдаваемый BotFather. Все запросы делаются по адресу `https://api.telegram.org/bot<token>/<method>`.

2. **chat_id** — идентификатор целевого чата. Для каналов используется формат `@channelusername`.

3. **message_thread_id** — идентификатор ветки в форуме супер-группы, если сообщение отправляется в отдельный топик.

4. **direct_messages_topic_id** — идентификатор темы личных сообщений канала (необходим при публикации в «direct messages» каналов).

5. **reply_markup** — опциональный объект, описывающий клавиатуру (inline или reply), либо принуждение к ответу. Полезен для интерактивных сценариев.

Все методы поддерживают параметры **disable_notification** (отправлять без звука), **protect_content** (запрет форварда/сохранения) и **allow_paid_broadcast** (ускоренная рассылка за Telegram Stars). Эти параметры приводятся здесь для полноты, но в проекте используются редко.

## 2. Отправка сообщений

### 2.1 Текстовые сообщения — sendMessage

Метод sendMessage используется для отправки текстовых сообщений. На успех возвращает объект Message.

| Параметр | Тип | Обязателен | Описание |
| :---- | :---- | :---- | :---- |
| **chat_id** | Integer/String | Да | Чат или @username канала, куда отправляется сообщение |
| **text** | String | Да | Текст сообщения (1-4096 символов) |
| **parse_mode** | String | Нет | Режим форматирования: Markdown, MarkdownV2 или HTML |
| **entities** | Array of MessageEntity | Нет | Альтернатива parse_mode — список сущностей с указанием диапазонов и типов |
| **link_preview_options** | LinkPreviewOptions | Нет | Настройки предпросмотра ссылок (вместо устаревшего disable_web_page_preview) |
| **reply_parameters** | ReplyParameters | Нет | Описание сообщения, на которое бот отвечает (включает message_id и опции цитирования) |
| **reply_markup** | InlineKeyboardMarkup/ReplyKeyboardMarkup/ReplyKeyboardRemove/ForceReply | Нет | Встроенная клавиатура либо просьба пользователю ответить |

#### Форматирование текста

Бот поддерживает оформление текста при помощи Markdown или HTML. Можно сделать **полужирный**, *курсивный*, __подчёркнутый__, ~зачёркнутый~, ||спойлер||, вставлять [гиперссылки](http://example.com) и блок-цитаты. В режиме MarkdownV2 специальные символы (например `_`, `*`, `[`, `]`, `(`, `)`, `~`, `` ` ``, `>`, `+`, `-`, `=`, `{`, `}`, `.`, `!`) должны быть экранированы обратной косой чертой. Кодовые блоки оформляются тройными апострофами (` ``` `), можно указать язык для подсветки синтаксиса.

### 2.2 Фото — sendPhoto

Используется для отправки изображений. Бот может передать файл (как InputFile), ссылку на картинку или file_id ранее загруженного файла. Размер фото — до 10 МБ; сумма ширины и высоты не должна превышать 10 000, а соотношение сторон — не более 1:20. К изображению можно добавить подпись (до 1024 символов) с форматированием.

| Параметр | Тип | Обязателен | Описание |
| :---- | :---- | :---- | :---- |
| **photo** | InputFile/String | Да | file_id, HTTP-URL или загрузка через multipart/form-data |
| **caption** | String | Нет | Подпись к фото (0-1024 символов) |
| **parse_mode**, **caption_entities**, **show_caption_above_media**, **has_spoiler** | — | Нет | Настройки форматирования подписи и отображения |

#### Загрузка новой фотографии и повторное использование

Отправлять изображения можно тремя способами:

1. **По file_id** — если фото уже сохранено на серверах Telegram, достаточно передать его идентификатор в поле photo. Это избавляет от повторной загрузки и снимает ограничения на размер. Обратите внимание, что идентификаторы уникальны для каждого бота и не всегда постоянны.

2. **По URL** — передайте прямую ссылку на изображение, и Telegram скачает его самостоятельно. Для фотографий доступен размер до 5 МБ.

3. **Через multipart/form-data** — загрузите файл с локального диска. Для фото лимит составляет 10 МБ. Параметр photo должен содержать имя файла, а сам файл передаётся как часть multipart-формы.

При загрузке нового файла сервер возвращает объект Message с массивом photo. Каждый элемент массива — это PhotoSize с различными разрешениями. В каждом из них присутствует поле file_id, которое нужно сохранить для повторного использования. Пример запроса с помощью **cURL**:

```bash
curl -X POST "https://api.telegram.org/bot<Токен>/sendPhoto" \
  -F "chat_id=<ID_чата>" \
  -F "photo=@/path/to/image.jpg" \
  -F "caption=Описание изображения"
```

В ответе JSON будет массив photo, например:

```json
{
  "ok": true,
  "result": {
    "message_id": 123,
    "chat": { ... },
    "photo": [
      {"file_id": "AgACAgIAAxkBAA...", "width": 90, "height": 90, ...},
      {"file_id": "AgACAgIAAxkBAA...", "width": 320, "height": 320, ...},
      {"file_id": "AgACAgIAAxkBAA...", "width": 640, "height": 640, ...}
    ],
    "caption": "Описание изображения"
  }
}
```

Сохраните file_id от наибольшего разрешения. В дальнейшем изображение можно отправлять, указав этот идентификатор в поле photo, без повторной загрузки.

Чтобы получить прямую ссылку на файл, воспользуйтесь методом **getFile**. Он возвращает объект File с полем file_path; затем файл можно скачать по адресу `https://api.telegram.org/file/bot<Токен>/<file_path>`. Ссылка действительна не менее часа, затем её можно обновить, вызвав getFile ещё раз.

Пример получения пути и ссылки:

```bash
# Получаем информацию о файле
curl "https://api.telegram.org/bot<Токен>/getFile?file_id=<file_id>"
# Ответ: {"ok":true,"result":{"file_id":"...","file_unique_id":"...","file_size":12345,"file_path":"photos/file_1.jpg"}}

# Скачиваем файл (опционально)
curl -O "https://api.telegram.org/file/bot<Токен>/photos/file_1.jpg"
```

После получения file_id или file_path вы можете отправлять фото сколь угодно раз, не превышая лимиты сервера.

### 2.3 Аудио — sendAudio

Позволяет отправлять музыкальные файлы в форматах MP3 или M4A. Максимальный размер — 50 МБ. Можно указать длительность, исполнителя, название трека и миниатюру (до 200 кБ).

### 2.4 Документы — sendDocument

Отправляет файлы любого типа. Размер — до 50 МБ. Бот может отправить файл, переданный через multipart-форму, HTTP-URL или file_id. Подпись и форматирование аналогичны sendPhoto.

### 2.5 Видео — sendVideo

Отправляет видеофайлы (поддерживаются MPEG4; другие форматы следует отправлять как документ). Лимит — 50 МБ. Дополнительно можно установить длительность, размер кадра, миниатюру, обложку, начальную позицию воспроизведения и флаг supports_streaming, позволяющий воспроизводить ролик до окончания загрузки.

### 2.6 Медиагруппы (альбомы) — sendMediaGroup

Используется для отправки до 10 фото, видео, документов или аудио как единого альбома. Все документы и аудио в группе должны быть одного типа (только документы или только аудио). Метод возвращает массив отправленных сообщений.

| Параметр | Тип | Обязателен | Описание |
| :---- | :---- | :---- | :---- |
| **chat_id** | Integer/String | Да | Идентификатор чата/канала для всех элементов альбома |
| **media** | Array of InputMediaPhoto / InputMediaVideo / InputMediaDocument / InputMediaAudio | Да | Список 2–10 элементов, описывающих каждый файл: тип, media (файл или URL), caption, parse_mode и т. д. |

## 3. Ответы и цитаты

### 3.1 Параметр reply_parameters

Для ответа на конкретное сообщение используйте объект reply_parameters, который передаётся в sendMessage, sendPhoto и других методах. В старой версии API использовался параметр reply_to_message_id, но сейчас рекомендуется новый объект, позволяющий тонко настроить цитирование.

Основные поля reply_parameters:

| Поле | Описание |
| :---- | :---- |
| **message_id** | Идентификатор сообщения, на которое отвечаем. Если бот отправляет ответ в том же чате, достаточно передать это поле. |
| **chat_id** | Опционально. Если нужно ответить на сообщение из другого чата (в пересылаемых сообщениях), укажите идентификатор этого чата. |
| **allow_sending_without_reply** | При true бот отправит сообщение, даже если исходное сообщение не найдено (в противном случае сервер вернёт ошибку). |
| **quote** | Поле для управления цитатой: можно указать часть текста исходного сообщения (offset/length) и форматирование, чтобы выводить короткую цитату. |

*Примечание:* некоторые возможности цитирования (например, выделенный текст, сокращение цитаты) появились только в Bot API 6.7+. Если старые клиенты их не поддерживают, они игнорируются.

### 3.2 Встраиваемые клавиатуры и кнопки

Параметр reply_markup в методах отправки сообщений позволяет добавлять inline-клавиатуры, кнопки для перехода по ссылке, выбора опции и т. д. Для публикации нарративов можно использовать кнопки «Далее», «Назад» или опросы. Структуры InlineKeyboardMarkup и InlineKeyboardButton описаны в официальной документации.

## 4. Редактирование сообщений

Telegram позволяет изменять ранее отправленные сообщения, их подписи, медиа или клавиатуру. Эти функции полезны, когда необходимо обновить контент без удаления сообщения.

### 4.1 Изменение текста — editMessageText

Используется для редактирования текстовых или игровых сообщений. Требуется указать пару chat_id и message_id (или inline_message_id). Новый текст передаётся в параметре text. Метод возвращает обновлённый объект Message или True для inline-сообщений. Важные параметры:

| Параметр | Описание |
| :---- | :---- |
| **text** | Новый текст сообщения (1-4096 символов) |
| **chat_id**, **message_id** | Определяют сообщение для редактирования. Обязательны, если inline_message_id не указан |
| **inline_message_id** | Идентификатор inline-сообщения, если редактируется сообщение, отправленное через inline-бота |
| **parse_mode** / **entities** | Настройка форматирования нового текста |
| **link_preview_options** | Включить или отключить предпросмотр ссылок |
| **reply_markup** | Новая inline-клавиатура (опционально) |

### 4.2 Изменение подписи — editMessageCaption

Позволяет изменить подпись у фото, видео, файла или аудио. В параметре caption передаётся новый текст подписи, который может быть пустым. Требуется указать chat_id и message_id или inline_message_id. Метод возвращает обновлённое сообщение либо True. Дополнительные параметры — parse_mode, caption_entities и флаг show_caption_above_media (подпись над изображением).

### 4.3 Изменение медиа — editMessageMedia

Используется для замены содержимого сообщения (фото, видео, аудио, документ) или для добавления медиа к текстовому сообщению. Новое содержимое передаётся как объект InputMedia (тип зависит от медиа: InputMediaPhoto, InputMediaVideo, InputMediaDocument или InputMediaAudio). Метод возвращает обновлённое сообщение либо True для inline-сообщений. Параметры:

| Параметр | Описание |
| :---- | :---- |
| **media** | Объект InputMedia* с новым содержимым |
| **chat_id**, **message_id** | Обязательны, если не используется inline_message_id |
| **reply_markup** | Новая inline-клавиатура (можно заменить или удалить) |

### 4.4 Изменение клавиатуры — editMessageReplyMarkup

Если нужно заменить только inline-клавиатуру без изменения текста или медиа, используйте editMessageReplyMarkup. Метод принимает chat_id и message_id или inline_message_id, а также новый объект reply_markup с клавиатурой. Возвращает обновлённый Message или True.

### 4.5 Удаление сообщений

* **deleteMessage** — удаляет одно сообщение. Требуются chat_id и message_id. Можно удалять свои сообщения в группах и каналах, а в каналах — только сообщения, опубликованные ботом.

* **deleteMessages** — удаляет массив сообщений. Параметры аналогичны, но message_ids передаётся в виде массива.

## 5. Получение и чтение сообщений

### 5.1 Получение обновлений — getUpdates

Бот может получать новые сообщения, реакции, редактирования и другие события через метод getUpdates. Это долгий опрос (long polling), при котором соединение удерживается до получения данных. Метод возвращает массив объектов Update. Основные параметры:

| Параметр | Описание |
| :---- | :---- |
| **offset** | Идентификатор первого обновления, которое нужно вернуть. После обработки каждого обновления увеличивайте offset, чтобы не получать его повторно. Можно указать отрицательное значение, чтобы пропустить несколько последних элементов очереди. |
| **limit** | Максимальное число обновлений (1-100, по умолчанию 100) |
| **timeout** | Тайм-аут в секундах для long polling. Значение 0 означает краткий опрос; для серверов обычно используют 20-60 секунд |
| **allowed_updates** | Список типов обновлений, которые бот хочет получать (например, message, edited_channel_post, callback_query). Если указать пустой список, бот получит все типы, кроме реакций и обновлений участников чата |

*Примечание:* getUpdates не работает, если настроен webhook. Для серверного приложения рекомендуется настроить webhook, который отправляет обновления на ваш URL, но для прототипов long polling удобен.

### 5.2 Информация о чате — getChat

Метод getChat возвращает актуальную информацию о группе, канале или пользователе. Достаточно передать chat_id; на успех возвращается объект ChatFullInfo. Эта информация включает название, описание, фото, статус (supergroup/channel/private), а также настройки форума или тем. Полезно при генерации описаний нарратива для канала.

### 5.3 Информация об участниках

Дополнительные методы помогают получать сведения об администраторах и участниках:

* **getChatAdministrators** — возвращает список администраторов в чате.

* **getChatMember** — получает статус конкретного пользователя (участник, администратор, заблокирован).

* **getChatMemberCount** — возвращает количество участников.

Эти методы требуют chat_id и, для некоторых, user_id.

## 6. Дополнительные возможности

### 6.1 Действия бота — sendChatAction

Чтобы показать пользователю, что бот что-то делает, используется метод sendChatAction. Он сообщает клиенту статус (например, «печатает…», «загружает фото», «записывает видео») в течение 5 секунд. Параметр action принимает значения typing, upload_photo, upload_video, upload_document и т. д. Метод помогает улучшить восприятие при долгих операциях.

### 6.2 Группы и каналы

* **Форумы и темы:** в супер-группах можно создавать ветки обсуждений. Параметр message_thread_id позволяет отправлять и получать сообщения в конкретной теме.

* **Direct messages в каналах:** начиная с Bot API 9.2 введены «direct messages» в каналах. Используйте direct_messages_topic_id, чтобы отправлять сообщения в такой чат, и читайте поле direct_messages_topic в объекте Message для определения темы.

### 6.3 Ограничения и советы

1. **Размеры файлов:** большинство медиа ограничены 50 МБ, фото — 10 МБ. Для более крупных файлов используйте собственный сервер Bot API, который поддерживает загрузку до 2 ГБ.

2. **Срок редактирования:** сообщения, не содержащие inline-клавиатур, отправленные бизнес-аккаунтом, можно редактировать только в течение 48 часов.

3. **Получение сообщений в каналах:** чтобы бот получал события в каналах, его нужно назначить администратором с правами «Post messages» или «Manage direct messages». Без этих прав бот не увидит сообщения.

4. **Цитаты и цепочки сообщений:** новые поля quote позволяют укороченно цитировать исходное сообщение. Используйте их аккуратно — старые клиенты Telegram могут не показать кастомную цитату.

## 7. Примеры запросов

Ниже приведены примеры запросов к Bot API в формате curl и на Python.

### 7.1 Отправка текста с форматированием и клавиатурой

```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{
        "chat_id": "@your_channel",
        "text": "*Глава 1:* _Вступление_\n\nСледующая страница — нажмите кнопку.",
        "parse_mode": "MarkdownV2",
        "reply_markup": {
            "inline_keyboard": [[{"text": "Продолжить", "callback_data": "next_1"}]]
        }
      }' \
  https://api.telegram.org/bot<YOUR_TOKEN>/sendMessage
```

### 7.2 Отправка фото с подписью

```bash
curl -X POST \
  -F chat_id=@your_channel \
  -F photo=@/path/to/image.jpg \
  -F caption="Это иллюстрация для истории." \
  https://api.telegram.org/bot<YOUR_TOKEN>/sendPhoto
```

### 7.3 Редактирование сообщения

```python
import requests

TOKEN = "<YOUR_TOKEN>"
BASE_URL = f"https://api.telegram.org/bot{TOKEN}"

# заменяем текст сообщения
def edit_message_text(chat_id: int, message_id: int, new_text: str):
    url = f"{BASE_URL}/editMessageText"
    payload = {
        "chat_id": chat_id,
        "message_id": message_id,
        "text": new_text,
        "parse_mode": "Markdown"
    }
    resp = requests.post(url, json=payload)
    return resp.json()

# пример использования
edit_message_text(chat_id=123456789, message_id=42, new_text="*Исправленный текст*")
```

## Заключение

Telegram Bot API предоставляет обширные возможности для отправки мультимедийных сообщений, их редактирования, цитирования и получения обновлений. Используя методы, описанные выше, можно построить бота, который публикует нарративы с красивым форматированием и собирает обратную связь из групп и каналов. Для более продвинутых сценариев (опросы, реакции, бизнес-функции) следует обращаться к официальной документации.
